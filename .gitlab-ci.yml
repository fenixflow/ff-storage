# GitLab CI/CD Pipeline for Fenix Packages
# Builds and publishes Python packages to GitLab Package Registry
# Only publishes when package version changes

stages:
  - check
  - build
  - test
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"
  PYTHON_VERSION: "3.11"

cache:
  paths:
    - .cache/pip
    - .cache/uv

# Default job configuration
default:
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - apt-get update && apt-get install -y git curl
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.local/bin/env
    - export PATH="/root/.local/bin:$PATH"
    - uv --version
    - python --version

# Detect which packages have changed
detect-changes:
  stage: check
  script:
    - |
      echo "Detecting changed packages..."
      chmod +x scripts/detect_changes.sh
      CHANGED_PACKAGES=$(./scripts/detect_changes.sh)
      
      if [ -z "$CHANGED_PACKAGES" ]; then
        echo "No packages have changed"
        echo "[]" > changed_packages.json
      else
        echo "Changed packages: $CHANGED_PACKAGES"
        echo "$CHANGED_PACKAGES" > changed_packages.json
      fi
  artifacts:
    paths:
      - changed_packages.json
    expire_in: 1 hour
  only:
    - main
    - merge_requests

# Build job template
.build-package:
  stage: build
  script:
    - |
      PACKAGE_NAME="${CI_JOB_NAME#build-}"
      echo "Building package: $PACKAGE_NAME"
      
      # Check if this package has changed
      if [ -f changed_packages.json ] && ! grep -q "\"$PACKAGE_NAME\"" changed_packages.json; then
        echo "Package $PACKAGE_NAME has not changed, skipping build"
        exit 0
      fi
      
      chmod +x scripts/build_package.sh
      ./scripts/build_package.sh "$PACKAGE_NAME"
  artifacts:
    paths:
      - "ff-storage/dist/"
      - "ff-logger/dist/"
      - changed_packages.json
    expire_in: 1 hour
  needs:
    - detect-changes
  only:
    - main
    - merge_requests

# Test job template
.test-package:
  stage: test
  allow_failure: true  # Tests can fail without blocking the pipeline
  script:
    - |
      PACKAGE_NAME="${CI_JOB_NAME#test-}"
      echo "Testing package: $PACKAGE_NAME"
      
      # Check if this package has changed
      if [ -f changed_packages.json ] && ! grep -q "\"$PACKAGE_NAME\"" changed_packages.json; then
        echo "Package $PACKAGE_NAME has not changed, skipping tests"
        exit 0
      fi
      
      cd "$PACKAGE_NAME"
      uv sync --extra dev
      
      # Run tests if they exist
      if [ -d "tests" ]; then
        uv run pytest tests/ -v
      else
        echo "No tests directory found, skipping tests"
      fi
      
      # Run linting
      uv run ruff check src/
      uv run black --check src/
  artifacts:
    paths:
      - changed_packages.json
    expire_in: 1 hour
  only:
    - main
    - merge_requests

# Publish job template
.publish-package:
  stage: publish
  script:
    - |
      PACKAGE_NAME="${CI_JOB_NAME#publish-}"
      echo "Publishing package: $PACKAGE_NAME"
      
      # Check if this package has changed
      if [ ! -f changed_packages.json ]; then
        echo "No change detection file found, skipping publish"
        exit 0
      fi
      
      if ! grep -q "\"$PACKAGE_NAME\"" changed_packages.json; then
        echo "Package $PACKAGE_NAME has not changed, skipping publish"
        exit 0
      fi
      
      echo "Package $PACKAGE_NAME has changed, proceeding with publish..."
      
      # Check if dist directory exists from build stage
      if [ ! -d "$PACKAGE_NAME/dist" ]; then
        echo "Warning: dist directory not found for $PACKAGE_NAME"
        echo "Build may have been skipped or failed. Attempting to build now..."
        chmod +x scripts/build_package.sh
        ./scripts/build_package.sh "$PACKAGE_NAME"
      fi
      
      # Run publish_if_new.sh which will check if the version exists
      # and only publish if it's missing from the registry
      chmod +x scripts/publish_if_new.sh
      ./scripts/publish_if_new.sh "$PACKAGE_NAME"
  # Note: Each package must specify its own needs
  only:
    - main

# Package-specific jobs
# Add a set of build/test/publish jobs for each package

# ff-storage package
build-ff-storage:
  extends: .build-package

test-ff-storage:
  extends: .test-package
  needs:
    - build-ff-storage

publish-ff-storage:
  extends: .publish-package
  needs:
    - detect-changes
    - build-ff-storage
    - test-ff-storage

# ff-logger package
build-ff-logger:
  extends: .build-package

test-ff-logger:
  extends: .test-package
  needs:
    - build-ff-logger

publish-ff-logger:
  extends: .publish-package
  needs:
    - detect-changes
    - build-ff-logger
    - test-ff-logger

# Add more packages here as they are created